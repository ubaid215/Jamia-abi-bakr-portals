generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ClassType {
  REGULAR // standard subjects (Dars-e-Nizami)
  NAZRA
  HIFZ
}

// For Dars-e-nizami progress
enum AssessmentType {
  CLASS_TEST
  MONTHLY_TEST
  TERM_EXAM
  FINAL_EXAM
  ASSIGNMENT
  PROJECT
  ORAL_TEST
  PRACTICAL
}

enum Grade {
  A_PLUS
  A
  B_PLUS
  B
  C_PLUS
  C
  D
  F
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String
  role         Role
  name         String
  phone        String?
  profileImage String?
  status       UserStatus @default(ACTIVE)

  // Add these fields for password security
  passwordChangedAt    DateTime? // Track when password was last changed
  passwordResetToken   String? // For forgot password functionality
  passwordResetExpires DateTime?

  // Add flag for forced password reset
  forcePasswordReset Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isOnline  Boolean  @default(false)

  // relations - only declare the relation name here, ownership is on the other side
  teacherProfile Teacher?
  studentProfile Student?
  parentProfile  Parent?

  // messages and uploads
  messagesSent          Message[]      @relation("sentMessages")
  messagesReceived      Message[]      @relation("receivedMessages")
  documentsUploaded     Document[]
  leaveRequestsReceived LeaveRequest[] @relation("adminLeaveRequests")
  chatRooms             ChatRoom[]     @relation("chatParticipants")

  @@index([role])
  @@index([status]) // Added index for status for better query performance
}

model Teacher {
  id     String  @id @default(uuid())
  user   User    @relation(fields: [userId], references: [id])
  userId String  @unique
  bio    String?

  // Enhanced teacher details
  dateOfBirth    DateTime?
  gender         String?
  cnic           String?   @unique // National ID
  qualification  String? // Academic qualifications
  specialization String? // Teaching specialization
  experience     String? // Years of experience

  // Contact details
  address                  String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  // Additional contact numbers
  phoneSecondary String?
  phoneEmergency String?

  // Documents
  profileImage    String? // URL to profile image
  cnicFront       String? // URL to CNIC front image
  cnicBack        String? // URL to CNIC back image
  degreeDocuments String? // JSON array of degree document URLs
  otherDocuments  String? // JSON array of other document URLs

  // Employment details
  joiningDate    DateTime?
  salary         Float?
  employmentType String? // Permanent, Contract, Part-time

  teacherSubjects TeacherSubject[]
  subjects        Subject[] // subjects directly assigned
  classes         ClassRoom[] // classes this teacher is assigned to
  leaveRequests   LeaveRequest[]     @relation("teacherLeaveRequests")
  dailyReports    DailyStudyReport[]
  attendances     Attendance[]
  nazraProgress   NazraProgress[]
  hifzProgress    HifzProgress[]

  // Add missing relation fields
  subjectProgress SubjectProgress[]
  monthlyProgress MonthlyProgress[]
  studyPlans      StudyPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// If teacher can teach multiple subjects
model TeacherSubject {
  id         String   @id @default(uuid())
  teacher    Teacher  @relation(fields: [teacherId], references: [id])
  teacherId  String
  subject    Subject  @relation(fields: [subjectId], references: [id])
  subjectId  String
  assignedAt DateTime @default(now())

  @@unique([teacherId, subjectId])
}

model Parent {
  id        String    @id @default(uuid())
  user      User      @relation(fields: [userId], references: [id])
  userId    String    @unique
  children  Student[] @relation("parentChildren")
  createdAt DateTime  @default(now())
}

model Student {
  id          String    @id @default(uuid())
  user        User      @relation(fields: [userId], references: [id])
  userId      String    @unique
  admissionNo String    @unique
  dob         DateTime?
  gender      String?

  // Student personal details
  placeOfBirth String?
  nationality  String? @default("Pakistani")
  religion     String? @default("Islam")
  bloodGroup   String?

  // Student documents
  profileImage              String? // URL to profile image
  birthCertificate          String? // URL to birth certificate
  cnicOrBForm               String? // URL to CNIC/B-Form
  previousSchoolCertificate String? // URL to previous school certificate
  otherDocuments            String? // JSON array of other document URLs

  // Medical information
  medicalConditions String? // Any medical conditions
  allergies         String? // Any allergies
  medication        String? // Regular medications

  // current enrollment relationship
  currentEnrollment   Enrollment? @relation("currentEnrollment", fields: [currentEnrollmentId], references: [id])
  currentEnrollmentId String?     @unique

  // all enrollments
  enrollments Enrollment[] @relation("studentEnrollments")

  attendances   Attendance[]
  examResults   ExamResult[]
  nazraProgress NazraProgress[]
  hifzProgress  HifzProgress[]
  parents       Parent[]        @relation("parentChildren")

  // Add missing relation fields
  subjectProgress SubjectProgress[]
  monthlyProgress MonthlyProgress[]
  studyPlans      StudyPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Guardian details (enhanced)
  guardianName       String?
  guardianRelation   String? // Father, Mother, Grandfather, etc.
  guardianPhone      String?
  guardianEmail      String?
  guardianOccupation String?
  guardianCNIC       String?

  // Secondary guardian
  guardian2Name     String?
  guardian2Relation String?
  guardian2Phone    String?
  guardian2Email    String?

  // Address details
  address    String?
  city       String?
  province   String?
  postalCode String?

  // Emergency contacts (other than guardians)
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
}

// New model to track admission number sequence
model AdmissionCounter {
  id         String   @id @default(uuid())
  year       Int      @unique // Academic year (e.g., 2025)
  lastNumber Int      @default(0) // Last assigned number for this year
  updatedAt  DateTime @updatedAt
}

model ClassRoom {
  id           String             @id @default(uuid())
  name         String // e.g., "Class 5A" or "Hifz Batch 1"
  grade        String? // optional grade string
  section      String? // optional
  type         ClassType          @default(REGULAR)
  description  String?
  teacher      Teacher?           @relation(fields: [teacherId], references: [id])
  teacherId    String?
  subjects     Subject[]
  enrollments  Enrollment[]       @relation("classEnrollments")
  attendances  Attendance[]
  dailyReports DailyStudyReport[]
  exams        Exam[]

  // Add missing relation field
  monthlyProgress MonthlyProgress[]

  // Roll number counter for this class
  lastRollNumber Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
}

model Subject {
  id              String             @id @default(uuid())
  name            String
  code            String? // optional code
  classRoom       ClassRoom?         @relation(fields: [classRoomId], references: [id])
  classRoomId     String?
  teacher         Teacher?           @relation(fields: [teacherId], references: [id])
  teacherId       String?
  teacherSubjects TeacherSubject[]
  attendances     Attendance[]
  dailyReports    DailyStudyReport[]
  exams           Exam[]

  // Add missing relation fields
  subjectProgress SubjectProgress[]
  studyPlans      StudyPlan[]
}

model Enrollment {
  id          String    @id @default(uuid())
  student     Student   @relation("studentEnrollments", fields: [studentId], references: [id])
  studentId   String
  classRoom   ClassRoom @relation("classEnrollments", fields: [classRoomId], references: [id])
  classRoomId String

  // Roll number for this enrollment
  rollNumber Int? // Roll number assigned in this class

  startDate  DateTime  @default(now())
  endDate    DateTime?
  promotedTo String? // notes about promotion or reason
  isCurrent  Boolean   @default(true)

  // This allows one enrollment to be marked as "current" for a student
  currentStudent Student? @relation("currentEnrollment")

  @@unique([classRoomId, rollNumber]) // Unique roll number per class
  @@index([studentId])
  @@index([classRoomId])
}

model SubjectProgress {
  id        String   @id @default(uuid())
  student   Student  @relation(fields: [studentId], references: [id])
  studentId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  subjectId String
  teacher   Teacher? @relation(fields: [teacherId], references: [id])
  teacherId String?

  // Assessment details
  assessmentType AssessmentType
  title          String? // e.g., "Chapter 1 Test", "Monthly Assessment"
  date           DateTime       @default(now())
  totalMarks     Int
  obtainedMarks  Int
  grade          Grade?
  percentage     Float

  // Detailed breakdown
  topicsCovered String? // JSON array of topics
  strengths     String? // JSON array of strengths
  weaknesses    String? // JSON array of weaknesses
  remarks       String?

  // Documents
  answerSheet String? // URL to scanned answer sheet
  attachments String? // JSON array of document URLs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, subjectId])
  @@index([date])
}

model MonthlyProgress {
  id          String    @id @default(uuid())
  student     Student   @relation(fields: [studentId], references: [id])
  studentId   String
  teacher     Teacher?  @relation(fields: [teacherId], references: [id])
  teacherId   String?
  classRoom   ClassRoom @relation(fields: [classRoomId], references: [id])
  classRoomId String

  // Monthly summary
  month      Int // 1-12
  year       Int
  attendance Json // { present: number, total: number, percentage: float }

  // Subject-wise performance
  subjectPerformance Json // { subjectId: { percentage: number, grade: string } }

  // Overall assessment
  overallGrade      Grade?
  overallPercentage Float
  remarks           String?
  improvements      String? // Areas for improvement
  recommendations   String? // Recommendations for next month

  // Behavior and participation
  behavior           String? // Excellent, Good, Satisfactory, Needs Improvement
  participation      String? // Active, Average, Low
  homeworkCompletion String? // Complete, Partial, Incomplete

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, month, year])
  @@index([studentId])
  @@index([classRoomId, month, year])
}

model StudyPlan {
  id        String  @id @default(uuid())
  student   Student @relation(fields: [studentId], references: [id])
  studentId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])
  teacherId String
  subject   Subject @relation(fields: [subjectId], references: [id])
  subjectId String

  // Plan details
  title       String
  description String?
  topics      String // JSON array of topics to cover
  startDate   DateTime
  endDate     DateTime
  priority    String? // High, Medium, Low

  // Progress tracking
  completedTopics String? // JSON array of completed topics
  status          String  @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  progress        Float   @default(0) // 0-100

  remarks     String?
  attachments String? // JSON array of document URLs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, subjectId])
  @@index([status])
}

model Attendance {
  id          String           @id @default(uuid())
  student     Student          @relation(fields: [studentId], references: [id])
  studentId   String
  classRoom   ClassRoom        @relation(fields: [classRoomId], references: [id])
  classRoomId String
  subject     Subject?         @relation(fields: [subjectId], references: [id])
  subjectId   String?
  teacher     Teacher?         @relation(fields: [teacherId], references: [id])
  teacherId   String?
  date        DateTime
  status      AttendanceStatus
  remarks     String?
  createdAt   DateTime         @default(now())

  @@index([studentId, date])
  @@index([classRoomId, date])
}

model DailyStudyReport {
  id          String    @id @default(uuid())
  teacher     Teacher   @relation(fields: [teacherId], references: [id])
  teacherId   String
  classRoom   ClassRoom @relation(fields: [classRoomId], references: [id])
  classRoomId String
  subject     Subject?  @relation(fields: [subjectId], references: [id])
  subjectId   String?
  date        DateTime  @default(now())
  content     String // plain text summary of the day's study
  attachments Json? // array of doc URLs / metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model LeaveRequest {
  id                  String      @id @default(uuid())
  teacher             Teacher     @relation("teacherLeaveRequests", fields: [teacherId], references: [id])
  teacherId           String
  appliedToAdmin      User?       @relation("adminLeaveRequests", fields: [adminId], references: [id])
  adminId             String?
  fromDate            DateTime
  toDate              DateTime
  reason              String
  status              LeaveStatus @default(PENDING)
  response            String?
  supportingDocuments String? // JSON array of document URLs
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}

model ChatRoom {
  id           String     @id @default(uuid())
  title        String?
  participants User[]     @relation("chatParticipants")
  messages     Message[]
  documents    Document[]
  createdAt    DateTime   @default(now())
  lastActive   DateTime   @updatedAt
}

model Message {
  id          String   @id @default(uuid())
  chatRoom    ChatRoom @relation(fields: [chatRoomId], references: [id])
  chatRoomId  String
  sender      User     @relation("sentMessages", fields: [senderId], references: [id])
  senderId    String
  receiver    User?    @relation("receivedMessages", fields: [receiverId], references: [id])
  receiverId  String?
  content     String?
  attachments Json? // array of doc URLs / metadata
  sentAt      DateTime @default(now())
  isRead      Boolean  @default(false)

  @@index([chatRoomId, sentAt])
}

model Document {
  id           String    @id @default(uuid())
  url          String
  fileName     String?
  mimeType     String?
  uploadedBy   User      @relation(fields: [uploadedById], references: [id])
  uploadedById String
  chatRoom     ChatRoom? @relation(fields: [chatRoomId], references: [id])
  chatRoomId   String?
  createdAt    DateTime  @default(now())
}

model Exam {
  id          String       @id @default(uuid())
  title       String
  classRoom   ClassRoom    @relation(fields: [classRoomId], references: [id])
  classRoomId String
  subject     Subject?     @relation(fields: [subjectId], references: [id])
  subjectId   String?
  date        DateTime
  totalMarks  Int
  createdAt   DateTime     @default(now())
  results     ExamResult[]
}

model ExamResult {
  id            String   @id @default(uuid())
  exam          Exam     @relation(fields: [examId], references: [id])
  examId        String
  student       Student  @relation(fields: [studentId], references: [id])
  studentId     String
  marksObtained Int
  grade         String?
  remarks       String?
  createdAt     DateTime @default(now())

  @@unique([examId, studentId])
  @@index([studentId])
}

/// Nazra-specific progress model
model NazraProgress {
  id           String   @id @default(uuid())
  student      Student  @relation(fields: [studentId], references: [id])
  studentId    String
  teacher      Teacher? @relation(fields: [teacherId], references: [id])
  teacherId    String?
  date         DateTime @default(now())
  recitedLines Int // number of lines recited this session
  mistakes     Int
  remarks      String?
  attachments  String? // JSON array of document URLs (audio recordings, notes, etc.)
  createdAt    DateTime @default(now())
}

// Hifz-specific progress model
model HifzProgress {
  id          String   @id @default(uuid())
  student     Student  @relation(fields: [studentId], references: [id])
  studentId   String
  teacher     Teacher? @relation(fields: [teacherId], references: [id])
  teacherId   String?
  date        DateTime @default(now())
  sabaqLines  Int // lines learned/reviewed in this session
  sabqiLines  Int // review lines
  manzilPara  String? // optional para description
  mistakes    Int
  notes       String?
  attachments String? // JSON array of document URLs (audio recordings, notes, etc.)
  createdAt   DateTime @default(now())

  // New fields for better tracking
  currentPara    Int? // Current Para number student is working on (1-30)
  completedParas Int[] // Array of completed Para numbers
  paraProgress   Float? // Progress percentage for current Para (0-100)

  @@index([studentId, date])
}
