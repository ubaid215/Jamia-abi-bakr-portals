generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== ENUMS ====================

enum Role {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  SUSPENDED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  HALF_DAY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ClassType {
  REGULAR
  NAZRA
  HIFZ
}

enum AssessmentType {
  CLASS_TEST
  MONTHLY_TEST
  TERM_EXAM
  FINAL_EXAM
  ASSIGNMENT
  PROJECT
  ORAL_TEST
  PRACTICAL
  QUIZ
  RECITATION
}

enum Grade {
  A_PLUS
  A
  B_PLUS
  B
  C_PLUS
  C
  D
  F
}

enum StudentType {
  REGULAR
  NAZRA
  HIFZ
  REGULAR_HIFZ
}

enum StudentMode {
  PHYSICAL // Student attends school in-person
  ONLINE // Student attends remotely/virtually
  HYBRID // Student attends both physical and online
}

enum GoalStatus {
  IN_PROGRESS
  ACHIEVED
  AT_RISK
  FAILED
  CANCELLED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  RESTORE
  ARCHIVE
  EXPORT
  IMPORT
  DOWNLOAD
}

enum AuditEntity {
  USER
  TEACHER
  STUDENT
  PARENT
  CLASSROOM
  SUBJECT
  ENROLLMENT
  ATTENDANCE
  DAILY_ACTIVITY
  WEEKLY_PROGRESS
  STUDENT_PROGRESS_SNAPSHOT
  PROGRESS_NOTIFICATION
  STUDENT_GOAL
  PARENT_COMMUNICATION
  SUBJECT_PROGRESS
  MONTHLY_PROGRESS
  STUDY_PLAN
  LEAVE_REQUEST
  EXAM
  EXAM_RESULT
  NAZRA_PROGRESS
  HIFZ_PROGRESS
  STUDENT_HIFZ_STATUS
  ACADEMIC_CONFIGURATION
  HOLIDAY
  MESSAGE
  DOCUMENT
  CHAT_ROOM
}

enum HolidayType {
  NATIONAL
  RELIGIOUS
  SCHOOL_EVENT
  SEMESTER_BREAK
  EXAM_PERIOD
  CUSTOM
}

// ==================== CORE USER MODELS ====================

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String
  role         Role
  name         String
  phone        String?
  profileImage String?
  status       UserStatus @default(ACTIVE)

  // Password security fields
  passwordChangedAt    DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?
  forcePasswordReset   Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isOnline  Boolean  @default(false)

  // Relations
  teacherProfile        Teacher?
  studentProfile        Student?
  parentProfile         Parent?
  messagesSent          Message[]      @relation("sentMessages")
  messagesReceived      Message[]      @relation("receivedMessages")
  documentsUploaded     Document[]
  leaveRequestsReceived LeaveRequest[] @relation("adminLeaveRequests")
  chatRooms             ChatRoom[]     @relation("chatParticipants")

  // ✅ CRITICAL PERFORMANCE INDEXES
  @@index([role, status])
  @@index([email])
  @@index([createdAt(sort: Desc)])
  @@index([isOnline, role])
  @@index([status, role])
}

model Teacher {
  id     String  @id @default(uuid())
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String  @unique
  bio    String?

  // Personal details
  dateOfBirth       DateTime?
  gender            String?
  cnic              String?   @unique
  qualification     String?
  specialization    String?
  experience        String?
  bloodGroup        String? // ← ADD
  medicalConditions String? // ← ADD

  // Contact details
  address                  String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  phoneSecondary           String?
  phoneEmergency           String?

  // Documents
  profileImage    String?
  cnicFront       String?
  cnicBack        String?
  degreeDocuments String?
  otherDocuments  String?

  // Employment details
  joiningDate    DateTime?
  salary         Float?
  employmentType String?

  // Bank details
  bankName      String? // ← ADD
  accountNumber String? // ← ADD
  iban          String? // ← ADD

  // Relations
  teacherSubjects       TeacherSubject[]
  subjects              Subject[]
  classes               ClassRoom[]
  leaveRequests         LeaveRequest[]        @relation("teacherLeaveRequests")
  dailyReports          DailyStudyReport[]
  attendances           Attendance[]
  nazraProgress         NazraProgress[]
  hifzProgress          HifzProgress[]
  subjectProgress       SubjectProgress[]
  monthlyProgress       MonthlyProgress[]
  studyPlans            StudyPlan[]
  dailyActivities       DailyActivity[]
  weeklyProgressReports WeeklyProgress[]
  studentGoals          StudentGoal[]
  parentCommunications  ParentCommunication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([cnic])
  @@index([employmentType, joiningDate])
  @@index([joiningDate(sort: Desc)])
}

model TeacherSubject {
  id         String   @id @default(uuid())
  teacher    Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  teacherId  String
  subject    Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  subjectId  String
  assignedAt DateTime @default(now())

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
}

model Parent {
  id       String    @id @default(uuid())
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String    @unique
  children Student[] @relation("parentChildren")

  // Parent Communication (Future Feature)
  communications ParentCommunication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Student {
  id          String      @id @default(uuid())
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String      @unique
  admissionNo String      @unique
  dob         DateTime?
  gender      String?
  studentType StudentType @default(REGULAR)

  // ✅ NEW: Student Mode (Physical/Online/Hybrid)
  studentMode   StudentMode @default(PHYSICAL)
  modeChangedAt DateTime? // Track when mode was last changed
  modeReason    String? // Reason for mode change

  // Personal details
  placeOfBirth String?
  nationality  String? @default("Pakistani")
  religion     String? @default("Islam")
  bloodGroup   String?

  // Documents
  profileImage              String?
  birthCertificate          String?
  cnicOrBForm               String?
  previousSchoolCertificate String?
  otherDocuments            String?

  // Medical information
  medicalConditions String?
  allergies         String?
  medication        String?

  // Current enrollment
  currentEnrollment   Enrollment? @relation("currentEnrollment", fields: [currentEnrollmentId], references: [id], onDelete: SetNull)
  currentEnrollmentId String?     @unique

  // Relations
  enrollments     Enrollment[]       @relation("studentEnrollments")
  attendances     Attendance[]
  examResults     ExamResult[]
  nazraProgress   NazraProgress[]
  hifzProgress    HifzProgress[]
  hifzStatus      StudentHifzStatus?
  parents         Parent[]           @relation("parentChildren")
  subjectProgress SubjectProgress[]
  monthlyProgress MonthlyProgress[]
  studyPlans      StudyPlan[]

  // Progress Tracking Relations (REGULAR students only)
  dailyActivities       DailyActivity[]
  weeklyProgress        WeeklyProgress[]
  progressSnapshot      StudentProgressSnapshot?
  progressNotifications ProgressNotification[]
  goals                 StudentGoal[]
  parentCommunications  ParentCommunication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Guardian details
  guardianName       String?
  guardianRelation   String?
  guardianPhone      String?
  guardianEmail      String?
  guardianOccupation String?
  guardianCNIC       String?

  // Secondary guardian
  guardian2Name     String?
  guardian2Relation String?
  guardian2Phone    String?
  guardian2Email    String?

  // Address
  address    String?
  city       String?
  province   String?
  postalCode String?

  // Emergency contacts
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  // ✅ CRITICAL PERFORMANCE INDEXES
  @@index([userId])
  @@index([admissionNo])
  @@index([currentEnrollmentId])
  @@index([gender, studentType])
  @@index([city, province])
  @@index([createdAt(sort: Desc)])
  @@index([studentType, studentMode]) // Filter by type and mode
  @@index([studentMode, currentEnrollmentId]) // Active students by mode
}

model AdmissionCounter {
  id         String   @id @default(uuid())
  year       Int      @unique
  lastNumber Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@index([year])
}

model ClassRoom {
  id              String             @id @default(uuid())
  name            String
  grade           String?
  section         String?
  type            ClassType          @default(REGULAR)
  description     String?
  teacher         Teacher?           @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId       String?
  subjects        Subject[]
  enrollments     Enrollment[]       @relation("classEnrollments")
  attendances     Attendance[]
  dailyReports    DailyStudyReport[]
  exams           Exam[]
  monthlyProgress MonthlyProgress[]

  // Progress Tracking Relations
  dailyActivities DailyActivity[]
  weeklyProgress  WeeklyProgress[]

  lastRollNumber Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ CRITICAL PERFORMANCE INDEXES
  @@index([type, grade])
  @@index([teacherId])
  @@index([grade, section])
  @@index([name])
  @@index([type, teacherId])
}

model Subject {
  id              String             @id @default(uuid())
  name            String
  code            String?
  classRoom       ClassRoom?         @relation(fields: [classRoomId], references: [id], onDelete: Cascade)
  classRoomId     String?
  teacher         Teacher?           @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId       String?
  teacherSubjects TeacherSubject[]
  attendances     Attendance[]
  dailyReports    DailyStudyReport[]
  exams           Exam[]
  subjectProgress SubjectProgress[]
  studyPlans      StudyPlan[]

  // Progress Tracking Relations
  dailyActivities DailyActivity[]

  // ✅ PERFORMANCE INDEXES
  @@index([classRoomId])
  @@index([teacherId])
  @@index([name])
  @@index([code])
  @@index([classRoomId, teacherId])
}

model Enrollment {
  id          String    @id @default(uuid())
  student     Student   @relation("studentEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  studentId   String
  classRoom   ClassRoom @relation("classEnrollments", fields: [classRoomId], references: [id], onDelete: Cascade)
  classRoomId String

  rollNumber Int?
  startDate  DateTime  @default(now())
  endDate    DateTime?
  promotedTo String?
  isCurrent  Boolean   @default(true)

  currentStudent Student? @relation("currentEnrollment")

  @@unique([classRoomId, rollNumber])
  // ✅ CRITICAL PERFORMANCE INDEXES
  @@index([studentId, isCurrent])
  @@index([classRoomId, isCurrent])
  @@index([startDate(sort: Desc)])
  @@index([endDate])
}

// ==================== DAILY ACTIVITY TRACKING (REGULAR STUDENTS ONLY) ====================

model DailyActivity {
  id          String    @id @default(uuid())
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId   String
  teacher     Teacher?  @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId   String?
  classRoom   ClassRoom @relation(fields: [classRoomId], references: [id], onDelete: Cascade)
  classRoomId String

  // ✅ Subject relation for teacher to select specific subject
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  subjectId String?

  date DateTime @default(now())

  // ✅ Link to existing Attendance system (Single Source of Truth)
  attendance   Attendance? @relation(fields: [attendanceId], references: [id], onDelete: SetNull)
  attendanceId String?

  // ✅ SIMPLIFIED: Derived from Attendance link
  attendanceStatus AttendanceStatus @default(PRESENT)

  // ✅ AUTO-CALCULATED: From class schedule (no manual entry)
  totalHoursSpent Float @default(0)

  // ✅ Academic Activities (Core Purpose - WHAT was learned)
  subjectsStudied Json // [{subjectId, topicsCovered: string[], understandingLevel: 1-5, notes: string}]

  // ✅ Assignments & Homework (Focused on quality, not logistics)
  homeworkAssigned  Json? // [{subjectId, title, dueDate, description}]
  homeworkCompleted Json? // [{subjectId, title, completionStatus: "COMPLETE|PARTIAL|NOT_DONE", quality: 1-5, notes: string}]

  // ✅ Classwork & Participation
  classworkCompleted Json? // [{subjectId, activity, completionStatus, quality: 1-5}]
  participationLevel Int   @default(3) // 1-5 scale per day

  // ✅ Assessments (if any conducted today)
  assessmentsTaken Json? // [{subjectId, type: "QUIZ|TEST|ORAL", topic, marksObtained, totalMarks}]

  // ✅ Behavioral & Discipline
  behaviorRating  Int @default(3) // 1-5 scale (1=Poor, 5=Excellent)
  disciplineScore Int @default(3) // 1-5 scale

  // ✅ DERIVED from Attendance system
  punctuality       Boolean @default(true)
  uniformCompliance Boolean @default(true)

  // ✅ Skills & Competencies
  skillsSnapshot Json? // {reading: 3, writing: 4, listening: 3, speaking: 4, criticalThinking: 3}

  // ✅ Teacher Observations
  strengths      String?
  improvements   String?
  concerns       String?
  teacherRemarks String?

  // ✅ Parent Communication (Structured notes)
  parentNotes String?

  // ✅ Metadata
  recordedBy String // teacherId who recorded
  isVerified Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ OPTIMIZED PERFORMANCE INDEXES
  @@unique([studentId, date])
  @@index([studentId, date(sort: Desc)])
  @@index([classRoomId, date(sort: Desc)])
  @@index([teacherId, date(sort: Desc)])
  @@index([subjectId, date(sort: Desc)])
  @@index([attendanceId])
  @@index([date(sort: Desc)])
  @@index([attendanceStatus, date])
  @@index([isVerified, date])
  @@index([recordedBy, date(sort: Desc)])
  @@index([studentId, subjectId, date(sort: Desc)])
}

// ==================== WEEKLY SUMMARY (REGULAR STUDENTS) ====================

model WeeklyProgress {
  id          String    @id @default(uuid())
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId   String
  teacher     Teacher?  @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId   String?
  classRoom   ClassRoom @relation(fields: [classRoomId], references: [id], onDelete: Cascade)
  classRoomId String

  weekNumber Int
  year       Int
  startDate  DateTime
  endDate    DateTime

  // ===== ATTENDANCE METRICS =====
  totalDaysPresent      Int   @default(0)
  totalDaysAbsent       Int   @default(0)
  totalDaysLate         Int   @default(0)
  totalDaysExcused      Int   @default(0)
  totalHolidays         Int   @default(0) // From academic configuration
  totalWorkingDays      Int   @default(0) // Excluding holidays
  attendancePercentage  Float @default(0)
  punctualityPercentage Float @default(0)

  // Subject-wise performance
  subjectWiseProgress Json // [{subjectId, name, topicsCompleted: count, avgUnderstanding: 1-5, assessments: [{type, score, outOf}], trend: "IMPROVING|STABLE|DECLINING"}]

  // Homework & Assignments
  homeworkAssignedCount  Int   @default(0)
  homeworkCompletedCount Int   @default(0)
  homeworkCompletionRate Float @default(0)
  averageHomeworkQuality Float @default(0)

  // Classwork
  classworkCompletionRate Float @default(0)
  averageClassworkQuality Float @default(0)

  // Assessments Summary
  totalAssessments    Int   @default(0)
  assessmentResults   Json? // [{subjectId, count, avgScore, avgPercentage}]
  overallAverageScore Float @default(0)

  // ===== BEHAVIORAL METRICS =====
  averageBehaviorScore      Float @default(0)
  averageParticipationScore Float @default(0)
  averageDisciplineScore    Float @default(0)
  uniformComplianceRate     Float @default(0)

  // Skills Development
  averageReadingSkill     Float @default(0)
  averageWritingSkill     Float @default(0)
  averageListeningSkill   Float @default(0)
  averageSpeakingSkill    Float @default(0)
  averageCriticalThinking Float @default(0)

  // ===== HIGHLIGHTS & FEEDBACK =====
  weeklyHighlights   String?
  areasOfImprovement String?
  strengthSubjects   String[] @default([])
  weakSubjects       String[] @default([])

  teacherComments String?

  // ===== ACHIEVEMENTS & INCIDENTS =====
  achievements Json? // [{title, description, date, category}]
  incidents    Json? // [{type: "POSITIVE|NEGATIVE", description, date, actionTaken}]

  // ===== RECOMMENDATIONS =====
  actionItems      Json? // [{category, item, priority, assignedTo}]
  followUpRequired Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ OPTIMIZED INDEXES
  @@unique([studentId, weekNumber, year])
  @@index([studentId, year, weekNumber(sort: Desc)])
  @@index([classRoomId, year, weekNumber(sort: Desc)])
  @@index([teacherId, year, weekNumber(sort: Desc)])
  @@index([startDate, endDate])
  @@index([followUpRequired, year])
  @@index([year, weekNumber(sort: Desc)])
}

// ==================== REAL-TIME PROGRESS DASHBOARD ====================

model StudentProgressSnapshot {
  id        String  @id @default(uuid())
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String  @unique

  // ===== CURRENT STATUS =====
  lastActivityDate DateTime?
  lastUpdated      DateTime  @updatedAt

  // Streaks
  currentAttendanceStreak Int @default(0)
  longestAttendanceStreak Int @default(0)
  currentHomeworkStreak   Int @default(0)

  // ===== OVERALL METRICS =====
  totalDaysAttended     Int   @default(0)
  totalDaysAbsent       Int   @default(0)
  totalHoursStudied     Float @default(0)
  overallAttendanceRate Float @default(0)

  // ===== ACADEMIC PERFORMANCE =====
  subjectWisePerformance Json? // [{subjectId, name, percentage, rank, trend: "UP|DOWN|STABLE", lastAssessment: {score, date}}]

  strongestSubjects String[] @default([])
  weakestSubjects   String[] @default([])
  improvingSubjects String[] @default([])
  decliningSubjects String[] @default([])

  // ===== HOMEWORK & ASSIGNMENTS =====
  overallHomeworkCompletionRate Float @default(0)
  averageHomeworkQuality        Float @default(0)
  pendingHomeworkCount          Int   @default(0)
  overdueHomeworkCount          Int   @default(0)

  // ===== BEHAVIORAL PROFILE =====
  averageBehaviorRating Float @default(0)
  averageParticipation  Float @default(0)
  averageDiscipline     Float @default(0)
  punctualityRate       Float @default(0)

  // ===== SKILLS ASSESSMENT =====
  currentReadingLevel     Float @default(0)
  currentWritingLevel     Float @default(0)
  currentListeningLevel   Float @default(0)
  currentSpeakingLevel    Float @default(0)
  currentCriticalThinking Float @default(0)

  // ===== RANKINGS & COMPARISONS =====
  classRank          Int?
  classTotalStudents Int?
  gradeRank          Int?
  percentileInClass  Float?

  // ===== ALERTS & FLAGS =====
  needsAttention   Boolean  @default(false)
  attentionReasons String[] @default([])
  flaggedSubjects  String[] @default([])

  riskLevel            RiskLevel @default(LOW)
  interventionRequired Boolean   @default(false)

  // ===== CACHE MANAGEMENT =====
  lastCalculatedAt   DateTime?
  nextCalculationDue DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ OPTIMIZED INDEXES
  @@index([studentId])
  @@index([needsAttention, riskLevel])
  @@index([riskLevel, interventionRequired])
  @@index([lastActivityDate(sort: Desc)])
  @@index([interventionRequired, needsAttention])
  @@index([currentAttendanceStreak(sort: Desc)])
  @@index([lastCalculatedAt])
}

// ==================== NOTIFICATIONS & UPDATES ====================

model ProgressNotification {
  id        String  @id @default(uuid())
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String

  recipientType String // STUDENT, TEACHER, ADMIN, SUPER_ADMIN, PARENT
  recipientId   String

  notificationType String
  category         String?
  priority         Priority @default(NORMAL)

  title   String
  message String
  data    Json?

  // Action items
  requiresAction Boolean   @default(false)
  actionType     String?
  actionDeadline DateTime?

  isRead Boolean   @default(false)
  readAt DateTime?

  actionUrl String?

  // Batch support
  batchId String?

  // Notification delivery
  deliveryMethod String[] @default(["IN_APP"])
  emailSent      Boolean  @default(false)
  smsSent        Boolean  @default(false)

  // Retry mechanism
  retryCount  Int       @default(0)
  lastRetryAt DateTime?

  createdAt DateTime  @default(now())
  expiresAt DateTime?

  // ✅ OPTIMIZED INDEXES
  @@index([recipientId, isRead, createdAt(sort: Desc)])
  @@index([studentId, notificationType, createdAt(sort: Desc)])
  @@index([priority, requiresAction, isRead])
  @@index([createdAt(sort: Desc)])
  @@index([expiresAt])
  @@index([batchId, createdAt])
  @@index([recipientType, recipientId, isRead])
}

// ==================== GOALS & TARGETS ====================

model StudentGoal {
  id        String   @id @default(uuid())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  teacher   Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId String?

  goalType String
  category String?

  title       String
  description String?

  metric        String
  targetValue   Float
  currentValue  Float  @default(0)
  baselineValue Float  @default(0)
  unit          String

  startDate  DateTime
  targetDate DateTime

  status     GoalStatus @default(IN_PROGRESS)
  achievedAt DateTime?

  progress Float @default(0)

  milestones Json?

  lastChecked    DateTime?
  checkFrequency String    @default("WEEKLY")

  supportActions    Json?
  relatedActivities String[] @default([])

  visibleToStudent Boolean @default(true)
  visibleToParent  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ OPTIMIZED INDEXES
  @@unique([studentId, title, startDate])
  @@index([studentId, status, targetDate])
  @@index([teacherId, status])
  @@index([targetDate(sort: Asc)])
  @@index([goalType, status])
  @@index([status, progress])
  @@index([checkFrequency, lastChecked])
}

// ==================== PARENT COMMUNICATION (FUTURE FEATURE) ====================

model ParentCommunication {
  id        String   @id @default(uuid())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  parent    Parent?  @relation(fields: [parentId], references: [id], onDelete: SetNull)
  parentId  String?
  teacher   Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId String?

  communicationType String
  subject           String
  message           String

  relatedActivity Json?

  // Meeting scheduling (future feature)
  meetingRequested Boolean   @default(false)
  meetingScheduled DateTime?
  meetingCompleted Boolean   @default(false)
  meetingNotes     String?

  parentResponse   String?
  parentResponseAt DateTime?
  acknowledged     Boolean   @default(false)

  sentVia     String[]  @default(["IN_APP"])
  deliveredAt DateTime?

  priority Priority @default(NORMAL)

  // Future feature flag
  isActive Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ OPTIMIZED INDEXES
  @@index([studentId, createdAt(sort: Desc)])
  @@index([parentId, acknowledged])
  @@index([teacherId, createdAt(sort: Desc)])
  @@index([communicationType, priority])
  @@index([meetingRequested, meetingCompleted])
  @@index([isActive, createdAt(sort: Desc)])
}

model SubjectProgress {
  id        String   @id @default(uuid())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  subjectId String
  teacher   Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId String?

  assessmentType AssessmentType
  title          String?
  date           DateTime       @default(now())
  totalMarks     Int
  obtainedMarks  Int
  grade          Grade?
  percentage     Float

  topicsCovered String?
  strengths     String?
  weaknesses    String?
  remarks       String?

  answerSheet String?
  attachments String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ CRITICAL PERFORMANCE INDEXES
  @@index([studentId, subjectId, date(sort: Desc)])
  @@index([date(sort: Desc)])
  @@index([assessmentType, date])
  @@index([teacherId, date])
  @@index([subjectId, date])
}

model MonthlyProgress {
  id          String    @id @default(uuid())
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId   String
  teacher     Teacher?  @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId   String?
  classRoom   ClassRoom @relation(fields: [classRoomId], references: [id], onDelete: Cascade)
  classRoomId String

  month              Int
  year               Int
  attendance         Json
  subjectPerformance Json

  overallGrade      Grade?
  overallPercentage Float
  remarks           String?
  improvements      String?
  recommendations   String?

  behavior           String?
  participation      String?
  homeworkCompletion String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ CRITICAL PERFORMANCE INDEXES
  @@unique([studentId, month, year])
  @@index([classRoomId, month, year])
  @@index([studentId, year, month(sort: Desc)])
  @@index([teacherId, year])
  @@index([year, month(sort: Desc)])
}

model StudyPlan {
  id        String  @id @default(uuid())
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  teacherId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  subjectId String

  title       String
  description String?
  topics      String
  startDate   DateTime
  endDate     DateTime
  priority    String?

  completedTopics String?
  status          String  @default("PENDING")
  progress        Float   @default(0)

  remarks     String?
  attachments String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ PERFORMANCE INDEXES
  @@index([studentId, status, startDate])
  @@index([teacherId, status])
  @@index([subjectId, status])
  @@index([startDate, endDate])
  @@index([status, priority])
}

model Attendance {
  id          String           @id @default(uuid())
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId   String
  classRoom   ClassRoom        @relation(fields: [classRoomId], references: [id], onDelete: Cascade)
  classRoomId String
  subject     Subject?         @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  subjectId   String?
  teacher     Teacher?         @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId   String?
  date        DateTime
  status      AttendanceStatus
  remarks     String?
  createdAt   DateTime         @default(now())

  hifzProgress HifzProgress? @relation("hifzAttendance")

  // Relation to DailyActivity
  dailyActivities DailyActivity[]

  // ✅ CRITICAL PERFORMANCE INDEXES
  @@index([date(sort: Desc)])
  @@index([studentId, date(sort: Desc)])
  @@index([classRoomId, date(sort: Desc)])
  @@index([teacherId, date])
  @@index([status, date])
  @@index([date, status])
  @@index([subjectId, date])
}

model DailyStudyReport {
  id          String    @id @default(uuid())
  teacher     Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  teacherId   String
  classRoom   ClassRoom @relation(fields: [classRoomId], references: [id], onDelete: Cascade)
  classRoomId String
  subject     Subject?  @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  subjectId   String?
  date        DateTime  @default(now())
  content     String
  attachments Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([teacherId, date(sort: Desc)])
  @@index([classRoomId, date(sort: Desc)])
  @@index([date(sort: Desc)])
  @@index([subjectId, date])
}

model LeaveRequest {
  id                  String      @id @default(uuid())
  teacher             Teacher     @relation("teacherLeaveRequests", fields: [teacherId], references: [id], onDelete: Cascade)
  teacherId           String
  appliedToAdmin      User?       @relation("adminLeaveRequests", fields: [adminId], references: [id], onDelete: SetNull)
  adminId             String?
  fromDate            DateTime
  toDate              DateTime
  reason              String
  status              LeaveStatus @default(PENDING)
  response            String?
  supportingDocuments String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // ✅ PERFORMANCE INDEXES
  @@index([teacherId, status, createdAt])
  @@index([status, fromDate])
  @@index([fromDate, toDate])
  @@index([createdAt(sort: Desc)])
  @@index([adminId, status])
}

model ChatRoom {
  id           String     @id @default(uuid())
  title        String?
  participants User[]     @relation("chatParticipants")
  messages     Message[]
  documents    Document[]
  createdAt    DateTime   @default(now())
  lastActive   DateTime   @updatedAt

  @@index([lastActive(sort: Desc)])
  @@index([createdAt])
}

model Message {
  id          String   @id @default(uuid())
  chatRoom    ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  chatRoomId  String
  sender      User     @relation("sentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  senderId    String
  receiver    User?    @relation("receivedMessages", fields: [receiverId], references: [id], onDelete: SetNull)
  receiverId  String?
  content     String?
  attachments Json?
  sentAt      DateTime @default(now())
  isRead      Boolean  @default(false)

  @@index([chatRoomId, sentAt(sort: Desc)])
  @@index([senderId, sentAt])
  @@index([receiverId, isRead, sentAt])
  @@index([isRead, sentAt])
}

model Document {
  id           String    @id @default(uuid())
  url          String
  fileName     String?
  mimeType     String?
  uploadedBy   User      @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  uploadedById String
  chatRoom     ChatRoom? @relation(fields: [chatRoomId], references: [id], onDelete: SetNull)
  chatRoomId   String?
  createdAt    DateTime  @default(now())

  @@index([uploadedById, createdAt])
  @@index([chatRoomId, createdAt])
  @@index([createdAt(sort: Desc)])
}

model Exam {
  id          String       @id @default(uuid())
  title       String
  classRoom   ClassRoom    @relation(fields: [classRoomId], references: [id], onDelete: Cascade)
  classRoomId String
  subject     Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  subjectId   String?
  date        DateTime
  totalMarks  Int
  createdAt   DateTime     @default(now())
  results     ExamResult[]

  @@index([classRoomId, date(sort: Desc)])
  @@index([subjectId, date])
  @@index([date(sort: Desc)])
}

model ExamResult {
  id            String   @id @default(uuid())
  exam          Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  examId        String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId     String
  marksObtained Int
  grade         String?
  remarks       String?
  createdAt     DateTime @default(now())

  @@unique([examId, studentId])
  @@index([studentId, createdAt])
  @@index([examId])
}

model NazraProgress {
  id           String   @id @default(uuid())
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId    String
  teacher      Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId    String?
  date         DateTime @default(now())
  recitedLines Int
  mistakes     Int
  remarks      String?
  attachments  String?
  createdAt    DateTime @default(now())

  // ✅ PERFORMANCE INDEXES
  @@index([studentId, date(sort: Desc)])
  @@index([teacherId, date(sort: Desc)])
  @@index([date(sort: Desc)])
}

model HifzProgress {
  id        String   @id @default(cuid())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  teacher   Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  teacherId String?
  date      DateTime @default(now())

  // ✅ SINGLE SOURCE OF TRUTH: Link to central Attendance model
  // When progress is saved, an Attendance record is auto-created and linked here.
  // attendance.status drives all attendance logic (no duplicate data).
  attendance   Attendance? @relation("hifzAttendance", fields: [attendanceId], references: [id], onDelete: SetNull)
  attendanceId String?     @unique // one-to-one: one HifzProgress per Attendance record

  // -----------------------------------------------------------------------
  // Sabaq: New memorization (lines count as integer — the core metric)
  // -----------------------------------------------------------------------
  sabaq         String? // Description e.g. "Al-Baqarah v1-5" (optional label)
  sabaqLines    Int     @default(0) // Number of new lines memorized today ← KEY METRIC
  sabaqMistakes Int     @default(0)

  // -----------------------------------------------------------------------
  // Sabqi: Recent revision (text description only — no line count needed)
  // -----------------------------------------------------------------------
  sabqi         String? // e.g. "Para 2" or "Para 1-3"
  sabqiMistakes Int     @default(0)

  // -----------------------------------------------------------------------
  // Manzil: Older revision (text description only — no line count needed)
  // -----------------------------------------------------------------------
  manzil         String? // e.g. "Para 1-5"
  manzilMistakes Int     @default(0)

  // -----------------------------------------------------------------------
  // Computed fields
  // -----------------------------------------------------------------------
  totalMistakes Int     @default(0) // sabaqMistakes + sabqiMistakes + manzilMistakes
  condition     String? // "Excellent" | "Good" | "Medium" | "Below Average" | "N/A"

  // -----------------------------------------------------------------------
  // Para progress tracking
  // -----------------------------------------------------------------------
  currentPara           Int?
  currentParaProgress   Float @default(0)
  completedParas        Int[] @default([])
  alreadyMemorizedParas Int[] @default([])
  startingPara          Int?

  notes       String?
  remarks     String?
  attachments String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ PERFORMANCE INDEXES
  @@index([studentId, date(sort: Desc)])
  @@index([teacherId, date(sort: Desc)])
  @@index([attendanceId])
  @@index([date(sort: Desc)])
  @@index([studentId, currentPara])
  @@index([condition, date])
}

model StudentHifzStatus {
  id        String  @id @default(uuid())
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String  @unique

  joiningDate           DateTime @default(now())
  alreadyMemorizedParas Int[]    @default([])
  startingPara          Int      @default(1)

  currentPara         Int   @default(1)
  currentParaProgress Float @default(0)
  completedParas      Int[] @default([])
  totalParasCompleted Int   @default(0)

  totalLinesMemorized Int   @default(0)
  totalDaysActive     Int   @default(0)
  averageLinesPerDay  Float @default(0)

  estimatedDaysToComplete Int?
  estimatedCompletionDate DateTime?

  totalMistakes         Int   @default(0)
  averageMistakesPerDay Float @default(0)
  mistakeRate           Float @default(0)
  consistencyScore      Float @default(0)

  isActive    Boolean   @default(true)
  completedAt DateTime?

  lastUpdated DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([studentId])
  @@index([isActive, currentPara])
  @@index([currentPara])
}

// ==================== COMPREHENSIVE AUDIT LOG ====================

model AuditLog {
  id String @id @default(uuid())

  // What happened
  action   AuditAction
  entity   AuditEntity
  entityId String

  // Who did it
  userId    String
  userName  String?
  userRole  Role
  userEmail String?

  // When
  timestamp DateTime @default(now())

  // Where (IP and location tracking)
  ipAddress String?
  userAgent String?

  // What changed
  changes Json? // {before: {...}, after: {...}}

  // Additional context
  description String?
  metadata    Json?

  // Request tracking
  requestId String?
  sessionId String?

  // Severity
  severity String @default("INFO") // INFO, WARNING, ERROR, CRITICAL

  // Tags for filtering
  tags String[] @default([])

  // Success/Failure
  isSuccess    Boolean @default(true)
  errorMessage String?

  // ✅ CRITICAL PERFORMANCE INDEXES
  @@index([entity, entityId, timestamp(sort: Desc)])
  @@index([userId, timestamp(sort: Desc)])
  @@index([action, entity, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@index([severity, timestamp(sort: Desc)])
  @@index([isSuccess, timestamp(sort: Desc)])
  @@index([requestId, timestamp])
  @@index([sessionId, timestamp])
  @@index([userRole, timestamp(sort: Desc)])
  @@index([tags, timestamp(sort: Desc)])
}

// ==================== ACADEMIC CONFIGURATION ====================

model AcademicConfiguration {
  id String @id @default(uuid())

  // Academic year settings
  academicYear String   @unique
  startDate    DateTime
  endDate      DateTime

  // Semester/Term configuration
  currentSemester   String?
  semesterStartDate DateTime?
  semesterEndDate   DateTime?

  // Weekly settings
  workingDays String[] @default(["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"])
  weekendDays String[] @default(["SATURDAY", "SUNDAY"])

  // Daily timings
  schoolStartTime String @default("08:00")
  schoolEndTime   String @default("14:00")

  // Period/Class duration
  periodDuration     Int @default(40)
  breakDuration      Int @default(10)
  lunchBreakDuration Int @default(30)

  // Attendance settings
  lateThresholdMinutes  Int   @default(15)
  halfDayThresholdHours Float @default(2)

  // Grading settings
  passingPercentage Float @default(40)
  gradeScale        Json?

  // Notification settings
  enableAutoNotifications Boolean @default(true)
  notificationTime        String  @default("17:00")

  // Progress tracking settings
  weeklyReportDay   String @default("FRIDAY")
  monthlyReportDate Int    @default(1)

  // Academic calendar metadata
  totalWorkingDays Int @default(0)
  totalHolidays    Int @default(0)

  // Status
  isActive  Boolean @default(true)
  isCurrent Boolean @default(false)

  // Metadata
  createdBy String
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  holidays Holiday[]

  // ✅ OPTIMIZED INDEXES
  @@index([academicYear])
  @@index([isActive, isCurrent])
  @@index([startDate, endDate])
  @@index([isCurrent])
}

// ==================== HOLIDAY MANAGEMENT ====================

model Holiday {
  id String @id @default(uuid())

  academicConfig   AcademicConfiguration @relation(fields: [academicConfigId], references: [id], onDelete: Cascade)
  academicConfigId String

  name        String
  description String?

  startDate DateTime
  endDate   DateTime

  type HolidayType

  // Recurrence
  isRecurring       Boolean @default(false)
  recurrencePattern String?

  // Affects specific classes or all
  affectsAllClasses  Boolean  @default(true)
  affectedClassRooms String[] @default([])

  // Status
  isActive           Boolean   @default(true)
  isCancelled        Boolean   @default(false)
  cancelledAt        DateTime?
  cancellationReason String?

  // Metadata
  createdBy String
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ OPTIMIZED INDEXES
  @@index([academicConfigId, startDate(sort: Asc)])
  @@index([startDate, endDate])
  @@index([type, startDate])
  @@index([isActive, isCancelled, startDate])
  @@index([startDate(sort: Asc)])
  @@index([academicConfigId, type, isActive])
}
